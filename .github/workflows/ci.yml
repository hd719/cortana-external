name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Detect package manager and install location
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          PM=""
          INSTALL_DIR=""

          # Prefer monorepo root lockfile when present
          if [ -f "pnpm-lock.yaml" ]; then
            PM="pnpm"
            INSTALL_DIR="."
          elif [ -f "package-lock.json" ]; then
            PM="npm"
            INSTALL_DIR="."
          elif [ -f "bun.lockb" ]; then
            PM="bun"
            INSTALL_DIR="."
          # Fall back to app-local lockfile
          elif [ -f "apps/mission-control/pnpm-lock.yaml" ]; then
            PM="pnpm"
            INSTALL_DIR="apps/mission-control"
          elif [ -f "apps/mission-control/package-lock.json" ]; then
            PM="npm"
            INSTALL_DIR="apps/mission-control"
          elif [ -f "apps/mission-control/bun.lockb" ]; then
            PM="bun"
            INSTALL_DIR="apps/mission-control"
          else
            echo "No supported lockfile found in repo root or apps/mission-control"
            exit 1
          fi

          echo "pm=$PM" >> "$GITHUB_OUTPUT"
          echo "install_dir=$INSTALL_DIR" >> "$GITHUB_OUTPUT"

      - name: Setup pnpm
        if: steps.detect.outputs.pm == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup bun
        if: steps.detect.outputs.pm == 'bun'
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies (pnpm)
        if: steps.detect.outputs.pm == 'pnpm'
        working-directory: ${{ steps.detect.outputs.install_dir }}
        run: pnpm install --frozen-lockfile

      - name: Install dependencies (npm)
        if: steps.detect.outputs.pm == 'npm'
        working-directory: ${{ steps.detect.outputs.install_dir }}
        run: npm ci

      - name: Install dependencies (bun)
        if: steps.detect.outputs.pm == 'bun'
        working-directory: ${{ steps.detect.outputs.install_dir }}
        run: bun install --frozen-lockfile

      - name: Run tests
        working-directory: apps/mission-control
        run: npx vitest run
